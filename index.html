<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento Andreia Kubichen</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <style>
        :root { --rosa: #f8bbd0; --rosa-escuro: #c48b9f; --pastel: #fff5f8; --texto: #5d4037; --verde: #81c784; --vermelho: #ff8a80; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--pastel); color: var(--texto); margin: 0; padding: 0; }
        header { background-color: var(--rosa); padding: 1.5rem 1rem; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .container { padding: 20px; max-width: 500px; margin: auto; }
        label { font-weight: 600; display: block; margin-top: 15px; margin-bottom: 5px; color: var(--rosa-escuro); }
        #calendar { background: white; padding: 10px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 15px; min-height: 300px; }
        .fc-daygrid-day.dia-disponivel { background-color: rgba(129, 199, 132, 0.2); }
        .fc-daygrid-day.dia-lotado { background-color: rgba(255, 138, 128, 0.4) !important; cursor: not-allowed !important; }
        .grade-horarios { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; display: none; }
        .hora-item { padding: 10px; background: white; border: 1px solid var(--rosa); border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
        .hora-item.selected { background: var(--rosa-escuro); color: white; border-color: var(--rosa-escuro); }
        .hora-item.bloqueado { background: #e0e0e0; color: #9e9e9e; border-color: #bdbdbd; cursor: not-allowed; text-decoration: line-through; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-confirmar { width: 100%; background-color: var(--verde); color: white; padding: 15px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .badge-admin { display: none; background: #ff5252; color: white; padding: 10px; border-radius: 10px; font-size: 12px; margin-bottom: 10px; text-align: center; font-weight: bold; }
        #btn-sair-admin, #btn-bloquear-dia { display: none; border: none; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; cursor: pointer; font-weight: bold; }
        #btn-sair-admin { background: #5d4037; color: white; }
        #btn-bloquear-dia { background: var(--vermelho); color: white; }
        .admin-footer { margin-top: 40px; text-align: center; font-size: 0.7rem; color: #ccc; }
        .btn-admin-link { background: none; border: none; color: #c48b9f; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<header>
    <h1 style="font-family: 'Playfair Display'; margin: 0; font-size: 1.6rem;">Agendamento Andreia Kubichen</h1>
</header>

<div class="container">
    <div id="aviso-admin" class="badge-admin">MODO ADMINISTRATIVO ATIVADO</div>
    <button id="btn-bloquear-dia" onclick="toggleBloqueioDia()">Bloquear/Liberar Dia Inteiro</button>
    <button id="btn-sair-admin" onclick="desativarAdmin()">Sair do Modo de Bloqueio</button>

    <label>1. Escolha o dia:</label>
    <div id="calendar"></div>

    <div id="secao-horarios">
        <label id="label-horario">2. Escolha o horário:</label>
        <div class="grade-horarios" id="grade-horarios"></div>
    </div>

    <label>3. Seus dados:</label>
    <input type="text" id="nome" placeholder="Seu Nome Completo">
    <select id="servico">
        <option value="" disabled selected>Selecione o serviço</option>
        <option value="Mão">Mão</option>
        <option value="Pé">Pé</option>
        <option value="Pé e Mão">Pé e Mão</option>
        <option value="Spa dos Pés">Spa dos Pés</option>
        <option value="Pé, Mão e Spa dos Pés">Pé, Mão e Spa dos Pés</option>
    </select>

    <button type="button" class="btn-confirmar" id="btn-finalizar" onclick="enviarAgendamento()">Finalizar Agendamento</button>

    <div class="admin-footer">
        <button class="btn-admin-link" onclick="ativarAdmin()">Acesso Restrito</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js"></script>

<script>
    // CONFIGURAÇÃO COM SEU LINK COPIADO
    var firebaseConfig = {
        apiKey: "AIzaSyAMLfQx1ip_-dwFeHzhkT82EUxcZ70G-Sc",
        authDomain: "agendaandreia-d7bd4.firebaseapp.com",
        databaseURL: "https://agendaandreia-d7bd4-default-rtdb.firebaseio.com/",
        projectId: "agendaandreia-d7bd4",
        storageBucket: "agendaandreia-d7bd4.firebasestorage.app",
        messagingSenderId: "188530942210",
        appId: "1:188530942210:web:23351dae0487611fc6621b"
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    var dataSelecionada = "";
    var horaSelecionada = "";
    var isAdmin = false;
    var horariosBase = ["08:30", "09:15", "10:00", "10:45", "11:30", "13:30", "14:15", "15:00", "15:45", "16:30", "17:15"];
    var bloqueios = {};
    var diasLotados = [];
    var calendar;

    db.ref('/').on('value', function(snapshot) {
        var data = snapshot.val() || {};
        bloqueios = data.bloqueios || {};
        diasLotados = data.diasLotados || [];
        if(calendar) calendar.render();
        atualizarGrade();
    });

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'pt-br',
            height: 'auto',
            dayCellClassNames: function(arg) {
                var d = arg.date;
                var dateStr = d.getFullYear() + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" + ("0"+d.getDate()).slice(-2);
                return (diasLotados && diasLotados.includes(dateStr)) ? ['dia-lotado'] : ['dia-disponivel'];
            },
            dateClick: function(info) {
                if (!isAdmin && diasLotados && diasLotados.includes(info.dateStr)) {
                    alert("Agenda completa ou fechada para este dia!");
                    return;
                }
                dataSelecionada = info.dateStr;
                atualizarGrade();
                document.querySelectorAll('.fc-daygrid-day').forEach(el => el.style.border = 'none');
                info.dayEl.style.border = '2px solid var(--rosa-escuro)';
            }
        });
        calendar.render();
    });

    function atualizarGrade() {
        if (!dataSelecionada) return;
        var grade = document.getElementById('grade-horarios');
        grade.style.display = 'grid';
        grade.innerHTML = "";
        var dataPt = dataSelecionada.split('-').reverse().join('/');
        
        horariosBase.forEach(function(h) {
            var div = document.createElement('div');
            var chave = dataPt + "_" + h;
            var estaBloqueado = bloqueios[chave] || (diasLotados && diasLotados.includes(dataSelecionada) && !isAdmin);

            div.className = 'hora-item' + (estaBloqueado ? ' bloqueado' : '');
            div.innerText = h;
            if(horaSelecionada === h && !estaBloqueado) div.classList.add('selected');
            
            div.onclick = function() {
                if (isAdmin) {
                    if (bloqueios[chave]) db.ref('bloqueios/'+chave).remove();
                    else db.ref('bloqueios/'+chave).set(true);
                } else if (!estaBloqueado) {
                    document.querySelectorAll('.hora-item').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    horaSelecionada = h;
                }
            };
            grade.appendChild(div);
        });
    }

    function toggleBloqueioDia() {
        if (!dataSelecionada) return;
        if(!diasLotados) diasLotados = [];
        var index = diasLotados.indexOf(dataSelecionada);
        if (index > -1) diasLotados.splice(index, 1);
        else diasLotados.push(dataSelecionada);
        db.ref('diasLotados').set(diasLotados);
    }

    function ativarAdmin() {
        var senha = prompt("Senha:");
        if (senha === "1234") {
            isAdmin = true;
            document.getElementById('aviso-admin').style.display = 'block';
            document.getElementById('btn-sair-admin').style.display = 'block';
            document.getElementById('btn-bloquear-dia').style.display = 'block';
            atualizarGrade();
        }
    }

    function desativarAdmin() {
        isAdmin = false;
        document.getElementById('aviso-admin').style.display = 'none';
        document.getElementById('btn-sair-admin').style.display = 'none';
        document.getElementById('btn-bloquear-dia').style.display = 'none';
        atualizarGrade();
    }

    function enviarAgendamento() {
        var nome = document.getElementById('nome').value;
        var servico = document.getElementById('servico').value;

        if (!dataSelecionada || !horaSelecionada || !nome || !servico) {
            alert("Preencha seu nome e escolha o serviço."); return;
        }

        var btn = document.getElementById('btn-finalizar');
        btn.innerText = "Confirmando...";
        btn.disabled = true;

        var dataPt = dataSelecionada.split('-').reverse().join('/');
        var chave = dataPt + "_" + horaSelecionada;

        // GRAVAÇÃO DIRETA
        db.ref('bloqueios/' + chave).set(true)
        .then(() => {
            var texto = "NOVO AGENDAMENTO\n*Cliente:* "+nome+"\n*Serviço:* "+servico+"\n*Data:* "+dataPt+"\n*Horário:* "+horaSelecionada;
            window.open("https://wa.me/5545988157875?text=" + encodeURIComponent(texto), '_blank');
            btn.innerText = "Finalizar Agendamento";
            btn.disabled = false;
        })
        .catch((error) => {
            alert("Erro ao gravar no banco. Verifique as 'Rules' no Firebase.");
            btn.innerText = "Finalizar Agendamento";
            btn.disabled = false;
        });
    }
</script>
</body>
</html>
